<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta charset='utf-8'>
        <title>API Reference &middot; Documentation &middot; NCPA</title>
        <link rel="shortcut icon" type="image/png" href="../img/ncpa.png" />
        <link rel="icon" type="image/png" href="../img/ncpa.png" />
        <link rel="stylesheet" href="../css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="../css/font-awesome.min.css" type="text/css" />
        <link rel="stylesheet" href="../css/ncpa.css" type="text/css" />
        <script src='../js/jquery.2.2.4.min.js'></script>
        <script src='../js/bootstrap.min.js'></script>
        <script src='../js/help.js'></script>
        <script type="text/javascript">
        $(document).ready(function() {
            $('.api-output').css('height', $('.api-output').parents('.row').height());

            $('.tt-bind').tooltip();

            // Get the API data
            var json_url = 'https://' + location.hostname+(location.port ? ':' + location.port : '') + '/api';
            $.get(json_url, { }, function(json) {
                $('.api-output').html(JSON.stringify(json, null, 4));
            }, 'json');
        });
        </script>
    </head>
    <body class="help">

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 col-lg-10">

                <h1>API Reference</h1>
                
                <p>The core of NCPA is the API, which works the same accross all platforms. It was designed to make it easy for administrators to set-up checks, troubleshoot problems, test checks, while still being flexible. This section covers how the API works with individual references for each module. Some of the extended nodes are specific to an operating system, but the standard nodes are available on any platform.</p>

                <a name="api-overview"></a>
                <div class="section">

                    <h2>Overview of the API</h2>
                    <div class="container-fluid">
                        <div class="row" style="margin: 0 -30px;">
                            <div class="col-sm-6">
                                <p>The API is constructed in a way that allows users to easily follow the hirearchy down, creating a URL that will access specific requested data.</p>
                                <p>In the example of this systems API return we see what we call <em>nodes</em>. Each node is a specific part of the API that gets specific data and functions a certain way. These are also sometimes referred to as <em>API endpoints</em> when farther down the list, when we have reached the end of a node.</p>
                                <p>Open up your web browser, and navigate to the URL below, replacing <em>localhost:5693</em> with your NCPA server hostname/IP and port or if you're reading this inside NCPA, you can look at the box.</p>
                                <pre>https://localhost:5693/api?token=mytoken</pre>
                                <p>The API is fromatted as JSON. If you're used to interacting with APIs, this shouldn't be too much of a surprise. However, something unique to NCPA is the way the API is accessed.</p>
                                <p>NCPA is structured with a set of base modules and each module has nodes. The nodes end up forming a URL, which is used to get data about that specific item or to run a check on that specific item's data.</p>
                                <p>Take a look at how an API call is formatted by hovering over each section:</p>
                                <pre style="cursor: default;"><span class="tt-bind" title="API URL">https://localhost:5693/api</span>  /  <span class="tt-bind" title="Module"><b>memory</b></span>  /  <span class="tt-bind" title="Nodes"><b>virtual/total</b></span>  ?  <span class="tt-bind" title="Extra URL GET parameters"><b>token=mytoken</b></span></pre>
                                <p>Nodes are direct key names shown in the JSON, so essentially you are creating a way to access the endpoint by selecting which nodes to follow. The module and nodes together form the endpoint requested. In this case, the endpoint would be <code>memory/virtual/total</code>. The additional URL parameters after the <code>?</code> are used to filter datasets, convert values or units, and authenticate using the token.</p>
                            </div>
                            <div class="col-sm-6">
                                <pre class="api-output"></pre>
                            </div>
                        </div>
                    </div>
                    
                </div>

                <a name="standard-parameters"></a>
                <div class="section">
                
                    <h2>Standard Parameters</h2>
                    <p>Accessing the API is just the starting point, there are set parameters that can be used on all modules and nodes. There are also some parameters, such as <code>delta</code> that are only available on certain nodes. The API reference at the end of this document explains the parameters that are abailable for use.</p>

                    <p>The most common parameters (via GET or POST) that are always available:</p>
                    <p>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th style="width: 10%; min-width: 100px;">Parameter</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><b>token</b></td>
                                    <td>The token used to authenticate. You must pass this with every API call. Corresponds to the <code>community_string</code> value in the config.</td>
                                </tr>
                                <tr>
                                    <td><b>units</b></td>
                                    <td>
                                        This is a special <em>prefix parameter</em> that will only work on endpoints that return <b>B</b> and <b>b</b>. It will convert the values into the type passed. An example is <code>units=Ki</code> would give you KiB. It converts the value (<code>KiB = B / 1024</code>) and returns the new value with the update unit. <em>Available options are <b>k</b>, <b>Ki</b>, <b>M</b>, <b>Mi</b>, <b>G</b>, <b>Gi</b>, <b>T</b>, <b>Ti</b>.</em>
                                    </td>
                                </tr>
                                <tr>
                                    <td><b>unit</b></td>
                                    <td>Unlike the units parameter, this value overwrites the unit name. If an endpoint returns no unit but you want it to return 'ms' then you can set this value.</td>
                                </tr>
                                <tr>
                                There are some results that are counters. Specifically, the interface counters simply count the bytes that pass through the interface. Set delta=1 for the NCPA server to calculate the change in the counter divided by the amount of time that has past since last check to create bytes/sec.
                                    <td><b>delta</b></td>
                                    <td>This is used on certain endpoints to create <em>per second</em> values. Particularly on interfaces, but can also be used in other places too. Setting <code>delta=1</code> will have NCPA calculate the change in the the value divided by the amount of time passed (in seconds) since the last check creating unit/sec values.</td>
                                </tr>
                            </tbody>
                        </table>
                    </p>

                    <h6>The Different Unit(s) Parameters</h6>
                    <p>The distinction between <code>units</code> and <code>unit</code> can be a bit confusing. Check out the examples below to see what these parameters do.</p>

                    <div class="container-fluid">
                        <div class="row" style="margin: 0 -30px;">
                            <div class="col-sm-12 col-lg-4">

                                <h6 style="margin-top: 1rem;">Example: Without Any Parameter</h6>
                                <p>This example shows what the standard value and unit would be without passing any special parameters.</p>
                                <pre>https://localhost:5693/api/disk/logical/C:|/used?token=mytoken</pre>
                                <p>This would output:</p>
                                <pre>{
    "total_size": [
        379222138880,
        "B"
    ]
}</pre>

                            </div>
                            <div class="col-sm-12 col-lg-4">
                                
                                <h6 style="margin-top: 1rem;">Example: Using <code>units</code> Parameter</h6>
                                <p>This example shows how the value and unit change when passing the <code>units</code> parameter to an endpoint that returns <b>B</b>.</p>
                                <pre>https://localhost:5693/api/disk/logical/C:|/used?token=mytoken&units=Gi</pre>
                                <p>This would return the value and units:</p>
                                <pre>{
    "total_size": [
        353.09,
        "GiB"
    ]
}</pre>

                            </div>
                            <div class="col-sm-12 col-lg-4">

                                <h6 style="margin-top: 1rem;">Example: Using <code>unit</code> Parameter</h6>
                                <p>This example shows how the value <em>does not change</em> but the unit, <em>no matter what the default unit is</em>, changes to <code>unit</code>.</p>
                                <pre>https://localhost:5693/api/disk/logical/C:|/used?token=mytoken&unit=Units</pre>
                                <p>This would return the value and units:</p>
                                <pre>{
    "total_size": [
        379222138880,
        "Units"
    ]
}</pre>

                            </div>
                        </div>
                    </div>

                </div>

                <a name="check-results"></a>
                <div class="section">

                    <h2>Returning Nagios Check Results</h2>
                    <p>Most of the endpoints in NCPA can be ran as a check, and return Nagios plugin-style check results. This is helpful for testing, and production. This style of API call is what the <code>check_ncpa.py</code> plugin uses to get the check results for things like the CPU, interface, memory, and disk.</p>
                    <p>The parameters (via GET or POST) available for running an API endpoint as a check:</p>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th style="width: 10%; min-width: 100px;">Parameter</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><b>check</b></td>
                                <td>In order to run the API endpoint as a check, you must pass <code>check=1</code> with the URL.</td>
                            </tr>
                            <tr>
                                <td><b>warning</b></td>
                                <td>Specifies the warning threshold for the check. <em>Conforms to the <a target="_new" href="https://nagios-plugins.org/doc/guidelines.html#THRESHOLDFORMAT">Nagios Plugins format guidelines</a> <i class="fa fa-external-link"></i>.</em></td>
                            </tr>
                            <tr>
                                <td><b>critical</b></td>
                                <td>Specifies the critical threshold for the check. <em>Conforms to the <a target="_new" href="https://nagios-plugins.org/doc/guidelines.html#THRESHOLDFORMAT">Nagios Plugins format guidelines</a> <i class="fa fa-external-link"></i>.</em></td>
                            </tr>
                        </tbody>
                    </table>

                    <h6>Example of an API Check</h6>
                    <p>You can get check results on most API endpoints. Below is an example of running a check on the API endpoint <code>memory/virtual/percent</code> which will return the used percent:</p>
                    <pre>https://localhost:5693/api/memory/virtual/percent?token=mytoken&warning=50&critical=60&check=1</pre>
                    <p>This would return the following result:</p>
                    <pre>{
    "returncode": 2, 
    "stdout": "CRITICAL: Percent was 76.80 % | 'percent'=76.80%;50;60;"
}</pre>
                    <p>If you are familiar with how a Nagios check works, this data should look familiar. The API will return the returncode and stdout for the check just like it would if it was running it from the command line. The <code>check_ncpa.py</code> plugin passes this data to Nagios by being a sort of proxy, printing the stdout and exiting with the return code given.</p>

                    <h6>Combined Check Results</h6>
                    <p>
                        <div class="alert alert-success">
                            <i class="fa fa-lightbulb-o fa-14 fa-l"></i> <b>Tip:</b> You can get combined checks using select node endpoints. Combined results are available from <code>disk/logical/&lt;partition&gt;</code>, <code>memory/swap</code>, <code>memory/virtual</code>, and <code>processes</code>.
                        </div>
                    </p>
                    <p>Certain node endpoints have the ability to combine all the nodes inside of them into a single check. This is really handy when you want to see all the data that the node has in a single line output. The warning and critical values will be applied to the main value given - but you will still see all the details so that in your Nagios display you can see what value of disk or memory is actually being used when it says a percent.</p>
                    <pre>https://localhost:5693/api/memory/virtual?token=mytoken&units=G&check=1</pre>
                    <p>Since we are using <code>memory/virtual</code> instead of <code>memory/virtual/&lt;option&gt;</code> we will get:</p>
                    <pre>{
    "returncode": 0, 
    "stdout": "OK: Used memory was 76.80 % (Available: 3.98 GB, Total: 17.13 GB, Free: 3.98 GB, Used: 13.15 GB) | 'percent'=76.80%;;;"
}</pre>
                    <p>You can see that it returns the value as a percentage, but also gives you values for available, total, free, and used.</p>

                </div>

                <a name="running-plugins"></a>
                <div class="section">

                    <h2>Running Nagios Plugins</h2>
                    <p>The NCPA API is flexible enough to let you run your own Nagios plugins. In order to do so, you'll need to place them in your plugins directory (plugin_path) defined in the <a href="configuration.html#plugin-directives">[plugin directives]</a> section of the config.</p>
                    <p>
                        <div class="alert alert-info">
                            <i class="fa fa-file-text-o fa-14 fa-l"></i> <b>Note:</b> Make sure that your plugins have the proper permissions on Linux and Mac OS X systems. They need to be able to be executed by the user and group you have specified the NCPA services to run as. <em>The default user and group is <b>nagios:nagios</b>. No permissions settings need to be edited for Windows.</em>
                        </div>
                    </p>
                    <p>You can see a list of all available plugins by going to the <code>plugins</code> API node:</p>
                    <pre>https://localhost:5693/api/plugins?token=mytoken</pre>
                    <pre>{
    "plugins": [
        "check_test.ps1",
        "check_mssql.vbs"
    ]
}</pre>
                    <p>The list above shows you the plugins that are available to run.</p>

                </div>

            </div>
        </div>
    </div>


<div class="section" id="using-nagios-plugins">

<p>Which shows all of the plugins that are installed. Now if we want to execute those plugins, we follow the same logic as we did above (for the non-plugin metrics). One new introduction is for plugins that take arguments. Simply separate them with the forward slashes. So for instance, to pass one argument to my test.vbs script, I would call:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://ncpaserver:5693/api/agent/plugin/test.vbs/&quot;First Arg&quot;?token=nagios
</pre></div>
</div>
<p>Which shows us the output:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;returncode&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;stdout&quot;</span><span class="p">:</span> <span class="s2">&quot;This worked! First Arg</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Which is what our script is supposed to do, return 2 and print &#8220;This Worked!&#8221; along with the first argument.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For plugins, the Check Result Specified do not apply. The result specified will work only for NCPA tree results.</p>
</div>
</div>
<div class="section" id="api-services">
<h2>API/Services<a class="headerlink" href="#api-services" title="Permalink to this headline"></a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Although the services tree changed in 1.7.0, backwards compatibility to the way the API worked in previous versions was added in 1.7.1 which allows old check_ncpa.py checks to work regardless of the version of the plugin script and the version of the NCPA agent installed.</p>
</div>
<p>The service tree has changed in NCPA 1.7.0 and now uses a more hybrid form of request. Like before, you can see the existing services and their current status by going to <code class="docutils literal"><span class="pre">api/service</span></code> but this is the end of the tree:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">ncpaserver</span><span class="p">:</span><span class="mi">5693</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">services</span>

<span class="p">{</span>
    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;services&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;auditd&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">,</span>
            <span class="s2">&quot;netfs&quot;</span><span class="p">:</span> <span class="s2">&quot;stopped&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sshd&quot;</span><span class="p">:</span> <span class="s2">&quot;running&quot;</span><span class="p">,</span>
            <span class="o">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using the above example should give you a list of all the services on your system in alphabetical order. Now if you would like to see a specific service, such as <strong>sshd</strong> in our instance, try:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://ncpaserver:5693/api/services?service=sshd

or

(Deprecated) https://ncpaserver:5693/api/service/sshd

{
    &quot;value&quot;: {
        &quot;service&quot;: {
            &quot;sshd&quot;: &quot;running&quot;
        }
    }
}
</pre></div>
</div>
<p>This will filter the list of services down to the service specified, <strong>sshd</strong> by using the <em>service</em> paramter. The output also shows it&#8217;s current status (running or stopped). You can also filter by multiple services by adding multipe parameters to the request. If we would have done <code class="docutils literal"><span class="pre">service=sshd&amp;service=auditd</span></code> we would have got two services back. You can also filter by status using the <em>status</em> parameter.</p>
<div class="section" id="monitoring-services-with-the-api">
<h3>Monitoring Services With the API<a class="headerlink" href="#monitoring-services-with-the-api" title="Permalink to this headline"></a></h3>
<p>Now in order for us to check if the service is running and give us the normal Nagios output, use:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>https://ncpaserver:5693/api/service?service=sshd&amp;status=running&amp;check=true

or

(Deprecated) https://ncpaserver:5693/api/service/sshd/running

{
    &quot;value&quot;: {
        &quot;returncode&quot;: 0,
        &quot;stdout&quot;: &quot;OK: Service sshd is running&quot;
    }
}
</pre></div>
</div>
<p>Using this type of request on <code class="docutils literal"><span class="pre">api/services</span></code> is how you will check to see if a service is running or not. Notice that the <em>status</em> parameter is set to what the status should be when the check is executed. In other words, the check above would have returned a CRITICAL stdout if the <em>status</em> parameter was set to stopped since it was running when the check was performed.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>

    </body>
</html>